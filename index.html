<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SnowGlass - å†¬å­£å“ˆæ°”é›ªèŠ±é•œ</title>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/control_utils/control_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/face_mesh.js" crossorigin="anonymous"></script>

    <style>
        :root {
            --glass-color: rgba(220, 235, 255, 0.1);
            --ui-bg: rgba(20, 30, 40, 0.6);
            --text-color: #ececec;
            --accent-color: #8ab4f8;
        }

        body, html {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
            background-color: #0a0e14;
            font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
        }

        #container {
            position: relative;
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        /* ä¸»æ¸²æŸ“ç”»å¸ƒ */
        #mainCanvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1;
            cursor: none; /* éšè—é»˜è®¤é¼ æ ‡ */
        }

        /* éšè—çš„è§†é¢‘è¾“å…¥å…ƒç´  */
        #inputVideo {
            display: none;
        }

        /* æç®€ UI é¢æ¿ */
        #uiPanel {
            position: absolute;
            top: 20px;
            right: 20px;
            background: var(--ui-bg);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            padding: 15px;
            border-radius: 16px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            z-index: 10;
            color: var(--text-color);
            width: 220px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: opacity 0.3s;
        }

        #uiPanel.hidden {
            opacity: 0.3;
        }
        #uiPanel:hover {
            opacity: 1;
        }

        .ui-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
            font-size: 14px;
        }
        .ui-row:last-child { margin-bottom: 0; }

        button {
            background: rgba(255, 255, 255, 0.1);
            border: none;
            color: var(--text-color);
            padding: 6px 12px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 12px;
            transition: background 0.2s;
        }
        button:hover { background: var(--accent-color); color: #1a1a1a; }
        button.active { background: var(--accent-color); color: #1a1a1a; }

        .status-text { font-size: 12px; color: #aaa; margin-top: 5px; text-align: center;}
        #breath-gauge-container {
            width: 100%; height: 6px; background: rgba(255,255,255,0.1); border-radius: 3px; overflow: hidden;
        }
        #breath-gauge-bar {
            height: 100%; width: 0%; background: var(--accent-color); transition: width 0.1s;
        }

        /* åŠ è½½è¦†ç›–å±‚ */
        #loadingOverlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: #0a0e14; z-index: 100; display: flex;
            justify-content: center; align-items: center; color: #8ab4f8; font-size: 18px;
            flex-direction: column;
        }
        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.1); border-top: 4px solid #8ab4f8;
            border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin-bottom: 20px;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

<div id="loadingOverlay">
    <div class="spinner"></div>
    <div id="loadingText">æ­£åœ¨åˆå§‹åŒ–æ¨¡å‹...</div>
</div>

<div id="container">
    <video id="inputVideo" playsinline></video>
    <canvas id="mainCanvas"></canvas>

    <div id="uiPanel">
        <div class="ui-row">
            <span style="font-weight: 600;">SnowGlass</span>
            <button id="cameraBtn">å¼€å¯æ‘„åƒå¤´</button>
        </div>
        <div class="status-text" id="cameraStatus">ç­‰å¾…æ“ä½œ...</div>
        <div style="margin: 15px 0; border-bottom: 1px solid rgba(255,255,255,0.1);"></div>
        <div class="ui-row">
            <span>å“ˆæ°”å¼ºåº¦ (ç©ºæ ¼é”®)</span>
            <div style="width: 80px;">
                <div id="breath-gauge-container">
                    <div id="breath-gauge-bar"></div>
                </div>
            </div>
        </div>
        <div class="ui-row">
            <span>é›ªèŠ±é£˜è½</span>
            <button id="snowBtn" class="active">å¼€</button>
        </div>
        <div class="ui-row">
            <span>å¯¹ç§°æ“¦æ‹­</span>
            <button id="symmetryBtn">å…³</button>
        </div>
        <div class="ui-row" style="margin-top:15px;">
             <button id="clearFogBtn" style="width:100%; background: rgba(255,100,100,0.2);">æ¸…é™¤æ‰€æœ‰é›¾æ°”</button>
        </div>
    </div>
</div>

<script>
/**
 * SnowGlass - æ ¸å¿ƒé€»è¾‘
 * åŒ…å«: Canvas2Dæ¸²æŸ“, MediaPipe Hooks, é›¾æ°”ç³»ç»Ÿ, ç²’å­ç³»ç»Ÿ, äº¤äº’å¹³æ»‘å¤„ç†
 */

// --- é…ç½®é¡¹ ---
const CONFIG = {
    fogMaxOpacity: 0.85,    // æœ€å¤§é›¾æ°”ä¸é€æ˜åº¦
    fogBuildRate: 0.02,     // å“ˆæ°”ç´¯ç§¯é€Ÿåº¦
    fogDecayRate: 0.0008,   // é›¾æ°”è‡ªç„¶æ¶ˆæ•£é€Ÿåº¦
    wipeSize: 45,           // æ“¦æ‹­ç¬”è§¦å¤§å°
    wipeSoftness: 0.6,      // æ“¦æ‹­è¾¹ç¼˜æŸ”å’Œåº¦ (0-1)
    handSmoothing: 0.15,    // æ‰‹æŒ‡ä½ç½®å¹³æ»‘ç³»æ•° (è¶Šå°è¶Šå¹³æ»‘ï¼Œå»¶è¿Ÿè¶Šé«˜)
    wipeActivationDelay: 800, // æ£€æµ‹åˆ°æ‰‹åå»¶è¿Ÿå¤šä¹…å¼€å§‹æ“¦æ‹­ (ms)
    breathThreshold: 0.12,  // å˜´å·´å¼ å¼€å¤šå¤§ç®—å“ˆæ°” (0-1 normalized)
    snowCount: 80,          // é›ªèŠ±æ•°é‡
    cameraBlur: 'blur(3px) brightness(0.7) contrast(1.1)', // æ‘„åƒå¤´èƒŒæ™¯æ»¤é•œ
    easterEggHoldTime: 60,  // è§¦å‘å½©è›‹éœ€è¦ä¿æŒæ‰‹åŠ¿çš„å¸§æ•° (çº¦1ç§’)
};

// --- çŠ¶æ€ç®¡ç† ---
const state = {
    isCameraRunning: false,
    isSnowEnabled: true,
    isSymmetryEnabled: false,
    breathStrength: 0,
    isSpacebarDown: false,
    modelsLoaded: { hands: false, face: false },
    handDetectedTime: 0, // è®°å½•æ‰‹é¦–æ¬¡è¢«æ£€æµ‹åˆ°çš„æ—¶é—´
    isWipingActive: false,
    easterEggCounter: 0,
    isEasterEggActive: false,
};

// --- DOM å…ƒç´  ---
const canvas = document.getElementById('mainCanvas');
const ctx = canvas.getContext('2d', { willReadFrequently: true }); // ä¼˜åŒ–è¯»å–æ“ä½œ
const videoElement = document.getElementById('inputVideo');
const uiBar = document.getElementById('breath-gauge-bar');
const cameraStatus = document.getElementById('cameraStatus');
const loadingOverlay = document.getElementById('loadingOverlay');
const loadingText = document.getElementById('loadingText');

// --- ç¦»å± Canvas (ç”¨äºç´¯ç§¯é›¾æ°”å±‚) ---
let fogCanvas, fogCtx;

// --- è¿½è¸ªæ•°æ®å®¹å™¨ ---
let handLandmarks = null;
let faceLandmarks = null;
// å¹³æ»‘åçš„æ‰‹æŒ‡ä½ç½®
let smoothedFinger = { x: 0, y: 0 };


// ==========================================
// åˆå§‹åŒ–ä¸ç³»ç»Ÿè®¾ç½®
// ==========================================
function initSystem() {
    resizeCanvas();
    window.addEventListener('resize', resizeCanvas);
    initFogLayer();
    setupUI();
    initSnow();
    loadMediaPipeModels();
    requestAnimationFrame(renderLoop); // å¯åŠ¨ä¸»æ¸²æŸ“å¾ªç¯
}

function resizeCanvas() {
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;
    if (fogCanvas) {
        // è°ƒæ•´å¤§å°éœ€è¦ä¿ç•™å½“å‰çš„é›¾æ°”ï¼Œç¨å¾®å¤æ‚ç‚¹ï¼Œè¿™é‡Œç®€åŒ–ä¸ºé‡ç½®
        initFogLayer(); 
    }
}

function initFogLayer() {
    fogCanvas = document.createElement('canvas');
    fogCanvas.width = canvas.width;
    fogCanvas.height = canvas.height;
    fogCtx = fogCanvas.getContext('2d', { willReadFrequently: true });
    // åˆå§‹å¡«æ»¡è½»å¾®çš„å†·è‰²é›¾æ°”
    fogCtx.fillStyle = 'rgba(200, 210, 230, 0.1)';
    fogCtx.fillRect(0, 0, fogCanvas.width, fogCanvas.height);
}

// ==========================================
// MediaPipe æ¨¡å‹åŠ è½½ä¸é…ç½®
// ==========================================
async function loadMediaPipeModels() {
    try {
        loadingText.textContent = "æ­£åœ¨åŠ è½½æ‰‹éƒ¨è¿½è¸ªæ¨¡å‹...";
        const hands = new Hands({locateFile: (file) => {
            return `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`;
        }});
        hands.setOptions({
            maxNumHands: 1,
            modelComplexity: 1,
            minDetectionConfidence: 0.6,
            minTrackingConfidence: 0.6
        });
        hands.onResults(onHandsResults);
        state.modelsLoaded.hands = true;

        loadingText.textContent = "æ­£åœ¨åŠ è½½é¢éƒ¨ç½‘æ ¼æ¨¡å‹...";
        const faceMesh = new FaceMesh({locateFile: (file) => {
            return `https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/${file}`;
        }});
        faceMesh.setOptions({
            maxNumFaces: 1,
            refineLandmarks: true,
            minDetectionConfidence: 0.6,
            minTrackingConfidence: 0.6
        });
        faceMesh.onResults(onFaceResults);
        state.modelsLoaded.face = true;

        // è®¾ç½®ç›¸æœºå·¥å…·
        const camera = new Camera(videoElement, {
            onFrame: async () => {
                if (!state.isCameraRunning) return;
                // é•œåƒå¤„ç†è§†é¢‘å¸§å†å‘é€ç»™æ¨¡å‹
                await hands.send({image: videoElement});
                await faceMesh.send({image: videoElement});
            },
            width: 1280,
            height: 720
        });
        window.cameraInstance = camera; // ä¿å­˜å®ä¾‹ä»¥ä¾¿å¯åŠ¨

        loadingOverlay.style.display = 'none'; // æ¨¡å‹åŠ è½½å®Œæ¯•ï¼Œéšè—é®ç½©
        cameraStatus.textContent = "æ¨¡å‹å°±ç»ªï¼Œè¯·å¼€å¯æ‘„åƒå¤´";

    } catch (e) {
        console.error("æ¨¡å‹åŠ è½½å¤±è´¥:", e);
        loadingText.textContent = "æ¨¡å‹åŠ è½½å¤±è´¥ï¼Œè¯·åˆ·æ–°é‡è¯•ã€‚";
        loadingText.style.color = "#ff6b6b";
    }
}

function onHandsResults(results) {
    if (results.multiHandLandmarks && results.multiHandLandmarks.length > 0) {
        handLandmarks = results.multiHandLandmarks[0];
    } else {
        handLandmarks = null;
        state.handDetectedTime = 0; // é‡ç½®æ£€æµ‹æ—¶é—´
        state.isWipingActive = false;
    }
}

function onFaceResults(results) {
    if (results.multiFaceLandmarks && results.multiFaceLandmarks.length > 0) {
        faceLandmarks = results.multiFaceLandmarks[0];
    } else {
        faceLandmarks = null;
    }
}

// ==========================================
// æ‘„åƒå¤´æ§åˆ¶
// ==========================================
function toggleCamera() {
    const btn = document.getElementById('cameraBtn');
    if (!state.isCameraRunning) {
        cameraStatus.textContent = "æ­£åœ¨è¯·æ±‚æ‘„åƒå¤´æƒé™...";
        window.cameraInstance.start()
            .then(() => {
                state.isCameraRunning = true;
                btn.textContent = "å…³é—­æ‘„åƒå¤´";
                btn.classList.add('active');
                cameraStatus.textContent = "æ‘„åƒå¤´å·²å¼€å¯ï¼Œç³»ç»Ÿè¿è¡Œä¸­";
            })
            .catch(err => {
                console.error("æ‘„åƒå¤´å¯åŠ¨å¤±è´¥:", err);
                cameraStatus.textContent = "æ— æ³•è®¿é—®æ‘„åƒå¤´ï¼Œè¯·æ£€æŸ¥æƒé™";
                btn.classList.remove('active');
            });
    } else {
        window.cameraInstance.stop();
        state.isCameraRunning = false;
        btn.textContent = "å¼€å¯æ‘„åƒå¤´";
        btn.classList.remove('active');
        cameraStatus.textContent = "æ‘„åƒå¤´å·²å…³é—­";
    }
}

// ==========================================
// æ ¸å¿ƒåŠŸèƒ½å®ç°: å“ˆæ°”ã€æ“¦æ‹­ã€å½©è›‹
// ==========================================

// 1. å“ˆæ°”é€»è¾‘ (åŸºäº FaceMesh æˆ–ç©ºæ ¼é”®)
function processBreath() {
    let strength = 0;

    if (state.isSpacebarDown) {
        strength = 0.8; // æ‰‹åŠ¨å“ˆæ°”å¼ºåº¦
    } else if (faceLandmarks) {
        // è®¡ç®—å˜´å·´å¼ å¼€åº¦ (ä¸Šå”‡ä¸­ç‚¹åˆ°ä¸‹å”‡ä¸­ç‚¹çš„è·ç¦»)
        // Meshç‚¹ä½: ä¸Šå”‡ä¸‹æ²¿ä¸­å¿ƒ(13), ä¸‹å”‡ä¸Šæ²¿ä¸­å¿ƒ(14)
        const upperLip = faceLandmarks[13];
        const lowerLip = faceLandmarks[14];
        // ç®€å•è®¡ç®—Yè½´è·ç¦»ï¼Œå½’ä¸€åŒ–å¤„ç†ï¼ˆå‡è®¾äººè„¸è·ç¦»é€‚ä¸­ï¼‰
        const distance = Math.abs(upperLip.y - lowerLip.y);
        // ç»éªŒå€¼: distance > 0.05 ç®—å¼ å˜´ã€‚å½’ä¸€åŒ–åˆ° 0-1
        strength = Math.max(0, (distance - 0.02) * 5);
        if (strength < CONFIG.breathThreshold) strength = 0;
        strength = Math.min(1, strength); // Clamp to 1
    }

    state.breathStrength = strength * 0.1 + state.breathStrength * 0.9; // å¹³æ»‘æ˜¾ç¤ºæ•°å€¼

    // æ›´æ–° UI è¿›åº¦æ¡
    uiBar.style.width = `${state.breathStrength * 100}%`;

    // å¦‚æœåœ¨å“ˆæ°”ï¼Œå‘é›¾æ°”å±‚æ·»åŠ é›¾
    if (strength > CONFIG.breathThreshold && faceLandmarks) {
        const mouthX = faceLandmarks[13].x * fogCanvas.width;
        const mouthY = faceLandmarks[13].y * fogCanvas.height;
        // é•œåƒä¿®æ­£Xåæ ‡ (å› ä¸ºè§†é¢‘æ˜¯é•œåƒçš„)
        const mirroredMouthX = fogCanvas.width - mouthX;

        addFog(mirroredMouthX, mouthY, strength);
    }
}

function addFog(x, y, intensity) {
    fogCtx.globalCompositeOperation = 'source-over';
    // ä½¿ç”¨å¾„å‘æ¸å˜æ¨¡æ‹ŸæŸ”å’Œçš„å“ˆæ°”
    const radius = 80 + intensity * 60;
    const gradient = fogCtx.createRadialGradient(x, y, 0, x, y, radius);
    gradient.addColorStop(0, `rgba(220, 235, 255, ${CONFIG.fogBuildRate * intensity})`);
    gradient.addColorStop(1, 'rgba(220, 235, 255, 0)');

    fogCtx.fillStyle = gradient;
    fogCtx.beginPath();
    fogCtx.arc(x, y, radius, 0, Math.PI * 2);
    fogCtx.fill();
}

// 2. æ“¦æ‹­é€»è¾‘ (åŸºäº Hands)
function processWipe() {
    // é›¾æ°”è‡ªç„¶æ¶ˆæ•£ (Decay)
    fogCtx.globalCompositeOperation = 'destination-out';
    fogCtx.fillStyle = `rgba(0,0,0, ${CONFIG.fogDecayRate})`;
    fogCtx.fillRect(0, 0, fogCanvas.width, fogCanvas.height);

    if (!handLandmarks) {
        state.isEasterEggActive = false; // æ‰‹æ¶ˆå¤±åˆ™é‡ç½®å½©è›‹çŠ¶æ€
        state.easterEggCounter = 0;
        return;
    }

    const now = Date.now();
    // æ£€æµ‹åˆ°æ‰‹åï¼Œè®°å½•æ—¶é—´
    if (state.handDetectedTime === 0) {
        state.handDetectedTime = now;
    }

    // è·å–é£ŸæŒ‡æŒ‡å°– (Index 8)
    const indexTip = handLandmarks[8];
    // é•œåƒä¿®æ­£Xåæ ‡
    const targetX = (1 - indexTip.x) * canvas.width;
    const targetY = indexTip.y * canvas.height;

    // ä½ç½®æŒ‡æ•°å¹³æ»‘ (Exponential Smoothing)
    smoothedFinger.x = smoothedFinger.x + (targetX - smoothedFinger.x) * CONFIG.handSmoothing;
    smoothedFinger.y = smoothedFinger.y + (targetY - smoothedFinger.y) * CONFIG.handSmoothing;

    // åˆ¤æ–­æ˜¯å¦è¿‡äº†æ¿€æ´»å»¶è¿ŸæœŸ
    if (now - state.handDetectedTime > CONFIG.wipeActivationDelay) {
        state.isWipingActive = true;
        // åªæœ‰æ²¡åœ¨è§¦å‘å½©è›‹æ—¶æ‰æ“¦æ‹­
        if (!state.isEasterEggActive) {
            applyWipe(smoothedFinger.x, smoothedFinger.y);
            if (state.isSymmetryEnabled) {
                 applyWipe(canvas.width - smoothedFinger.x, smoothedFinger.y);
            }
        }
    } else {
        state.isWipingActive = false;
        // å¯ä»¥åœ¨è¿™é‡Œç»˜åˆ¶ä¸€ä¸ªâ€œå‡†å¤‡ä¸­â€çš„å…‰æ ‡
    }
    
    detectEasterEggGesture();
}

function applyWipe(x, y) {
    fogCtx.globalCompositeOperation = 'destination-out';
    // ä½¿ç”¨å¾„å‘æ¸å˜å®ç°æŸ”å’Œè¾¹ç¼˜çš„æ“¦é™¤
    const gradient = fogCtx.createRadialGradient(x, y, 0, x, y, CONFIG.wipeSize);
    // ä¸­å¿ƒå®Œå…¨æ“¦é™¤(alpha 1)ï¼Œè¾¹ç¼˜æ¸å˜åˆ°ä¸æ“¦é™¤(alpha 0)
    gradient.addColorStop(0, 'rgba(0,0,0,1)');
    gradient.addColorStop(CONFIG.wipeSoftness, 'rgba(0,0,0,1)'); 
    gradient.addColorStop(1, 'rgba(0,0,0,0)');

    fogCtx.fillStyle = gradient;
    fogCtx.beginPath();
    fogCtx.arc(x, y, CONFIG.wipeSize, 0, Math.PI * 2);
    fogCtx.fill();
}

// 6. å½©è›‹: è¯†åˆ« "Victory/Peace" æ‰‹åŠ¿ (é£ŸæŒ‡+ä¸­æŒ‡ä¼¸ç›´ï¼Œå…¶ä»–å¼¯æ›²)
function detectEasterEggGesture() {
    if (!handLandmarks) return;
    // ç®€åŒ–åˆ¤æ–­ï¼šé£ŸæŒ‡æŒ‡å°–(8)å’Œä¸­æŒ‡æŒ‡å°–(12)éƒ½é«˜äºå®ƒä»¬å„è‡ªçš„å…³èŠ‚(6, 10)ï¼Œä¸”ä¸¤è€…è·ç¦»é€‚ä¸­
    const indexTip = handLandmarks[8];
    const middleTip = handLandmarks[12];
    const indexPip = handLandmarks[6];
    const middlePip = handLandmarks[10];
    const wrist = handLandmarks[0];

    const isIndexUp = indexTip.y < indexPip.y;
    const isMiddleUp = middleTip.y < middlePip.y;
    
    // è®¡ç®—ä¸¤æŒ‡å°–è·ç¦»
    const dx = indexTip.x - middleTip.x;
    const dy = indexTip.y - middleTip.y;
    const tipDistance = Math.sqrt(dx*dx + dy*dy);
    
    // ç®€å•çš„æ‰‹åŠ¿åˆ¤å®šé€»è¾‘ (å¯ä»¥æ ¹æ®éœ€è¦è°ƒä¼˜)
    if (isIndexUp && isMiddleUp && tipDistance > 0.04 && tipDistance < 0.15) {
        state.easterEggCounter++;
    } else {
        state.easterEggCounter = Math.max(0, state.easterEggCounter - 2); // ç¼“æ…¢ä¸‹é™
    }

    // è§¦å‘å½©è›‹
    if (state.easterEggCounter > CONFIG.easterEggHoldTime) {
        state.isEasterEggActive = true;
        state.easterEggCounter = CONFIG.easterEggHoldTime; // Clamp
        triggerEasterEggEffect();
    }
}

function triggerEasterEggEffect() {
    // ç®€å•çš„å½©è›‹æ•ˆæœï¼šç¬é—´å¢åŠ å¤§é‡é›ªèŠ±ï¼Œå¹¶æ”¹å˜é¢œè‰²
    if(snowParticles.length < CONFIG.snowCount * 2) {
         for(let i=0; i<20; i++) {
             snowParticles.push(new SnowParticle(true)); // true è¡¨ç¤ºæ˜¯å½©è›‹ç²’å­
         }
    }
}


// ==========================================
// é›ªèŠ±ç³»ç»Ÿ
// ==========================================
let snowParticles = [];
class SnowParticle {
    constructor(isBonus = false) {
        this.reset(true);
        this.isBonus = isBonus;
        if (isBonus) {
             this.color = `hsl(${Math.random() * 360}, 70%, 80%)`;
             this.size = Math.random() * 4 + 2;
             this.speedY = Math.random() * 3 + 2;
        } else {
            this.color = 'rgba(255, 255, 255, 0.8)';
        }
    }
    reset(initial = false) {
        this.x = Math.random() * canvas.width;
        this.y = initial ? Math.random() * canvas.height : -10;
        this.size = Math.random() * 3 + 1;
        this.speedY = Math.random() * 1.5 + 0.5;
        this.wobble = Math.random() * Math.PI * 2;
        this.wobbleSpeed = Math.random() * 0.05 + 0.01;
    }
    update() {
        this.y += this.speedY;
        this.wobble += this.wobbleSpeed;
        this.x += Math.sin(this.wobble) * 0.5;

        if (this.y > canvas.height) {
            if (this.isBonus) {
                 // å½©è›‹ç²’å­æ‰å‡ºå±å¹•åç§»é™¤
                 return false;
            }
            this.reset();
        }
        return true;
    }
    draw(c) {
        c.fillStyle = this.color;
        c.beginPath();
        c.arc(this.x, this.y, this.size, 0, Math.PI * 2);
        c.fill();
    }
}

function initSnow() {
    for (let i = 0; i < CONFIG.snowCount; i++) {
        snowParticles.push(new SnowParticle());
    }
}

function renderSnow() {
    if (!state.isSnowEnabled) return;
    // æ›´æ–°å¹¶è¿‡æ»¤æ‰éœ€è¦ç§»é™¤çš„ç²’å­
    snowParticles = snowParticles.filter(p => {
        p.draw(ctx);
        return p.update();
    });
    // å¦‚æœå½©è›‹ç»“æŸï¼Œè¡¥å……æ™®é€šé›ªèŠ±åˆ°åŸºå‡†æ•°é‡
    while (snowParticles.length < CONFIG.snowCount && !state.isEasterEggActive) {
         snowParticles.push(new SnowParticle());
    }
}

// ==========================================
// ä¸»æ¸²æŸ“å¾ªç¯ (The Core Loop)
// ==========================================
function renderLoop() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);

    // 1. å¤„ç†äº¤äº’é€»è¾‘ (æ›´æ–°çŠ¶æ€ï¼Œä½†ä¸ç›´æ¥ç»˜åˆ¶åˆ°ä¸»ç”»å¸ƒ)
    if (state.isCameraRunning) {
        processBreath();
        processWipe();
    }

    // ----- å›¾å±‚åˆæˆå¼€å§‹ -----

    // Layer 1: è§†é¢‘èƒŒæ™¯å±‚ (å¸¦æ»¤é•œ)
    ctx.save();
    // é•œåƒå¹¶åº”ç”¨æ»¤é•œ
    ctx.translate(canvas.width, 0);
    ctx.scale(-1, 1);
    ctx.filter = CONFIG.cameraBlur;
    if (state.isCameraRunning && videoElement.readyState === 4) {
        ctx.drawImage(videoElement, 0, 0, canvas.width, canvas.height);
    } else {
        // ç›¸æœºæœªå¼€å¯æ—¶çš„å ä½èƒŒæ™¯
        ctx.fillStyle = '#0a0e14';
        ctx.fillRect(0, 0, canvas.width, canvas.height);
    }
    ctx.filter = 'none'; // é‡ç½®æ»¤é•œ
    ctx.restore();


    // Layer 2: ç»ç’ƒè´¨æ„Ÿå åŠ å±‚ ( subtle reflection/gradient )
    // ä½¿ç”¨çº¿æ€§æ¸å˜æ¨¡æ‹Ÿç»ç’ƒåå…‰
    const glassGradient = ctx.createLinearGradient(0, 0, canvas.width, canvas.height);
    glassGradient.addColorStop(0, 'rgba(255, 255, 255, 0.05)');
    glassGradient.addColorStop(0.5, 'rgba(200, 220, 255, 0.02)');
    glassGradient.addColorStop(1, 'rgba(255, 255, 255, 0.08)');
    ctx.fillStyle = glassGradient;
    ctx.fillRect(0, 0, canvas.width, canvas.height);


    // Layer 3: é›¾æ°”å±‚
    // å°†ç¦»å±çš„é›¾æ°” Canvas ç»˜åˆ¶ä¸Šæ¥
    // æ§åˆ¶æœ€å¤§ä¸é€æ˜åº¦
    ctx.globalAlpha = CONFIG.fogMaxOpacity;
    ctx.drawImage(fogCanvas, 0, 0);
    ctx.globalAlpha = 1.0;


    // Layer 4: äº¤äº’åé¦ˆä¸å‰æ™¯
    // ç»˜åˆ¶æ“¦æ‹­ç‚¹å…‰æ ‡ (å¦‚æœæ¿€æ´»)
    if (state.isWipingActive && !state.isEasterEggActive) {
        drawWipeCursor(smoothedFinger.x, smoothedFinger.y);
        if (state.isSymmetryEnabled) {
             drawWipeCursor(canvas.width - smoothedFinger.x, smoothedFinger.y);
        }
    } else if (handLandmarks && !state.isWipingActive) {
         // å‡†å¤‡çŠ¶æ€çš„å…‰æ ‡ (è¿˜æ²¡å¼€å§‹æ“¦)
         drawWaitingCursor(smoothedFinger.x, smoothedFinger.y);
    }
    
    // å½©è›‹è§¦å‘æç¤º
    if (state.isEasterEggActive) {
        ctx.fillStyle = "rgba(255, 255, 100, 0.8)";
        ctx.font = "20px sans-serif";
        ctx.textAlign = "center";
        ctx.fillText("ğŸ‰ å½©è›‹è§¦å‘! ğŸ‰", canvas.width/2, 100);
    }

    // Layer 5: é›ªèŠ±å±‚
    renderSnow();

    // ----- å›¾å±‚åˆæˆç»“æŸ -----

    requestAnimationFrame(renderLoop);
}

function drawWipeCursor(x, y) {
    ctx.beginPath();
    ctx.arc(x, y, 8, 0, Math.PI * 2);
    ctx.fillStyle = 'rgba(255, 255, 255, 0.6)';
    ctx.fill();
    // å¤–å‘å…‰åœˆ
    ctx.beginPath();
    ctx.arc(x, y, 12, 0, Math.PI * 2);
    ctx.strokeStyle = 'rgba(138, 180, 248, 0.4)';
    ctx.lineWidth = 2;
    ctx.stroke();
}

function drawWaitingCursor(x, y) {
    // ä¸€ä¸ªå¸¦æœ‰åŠ è½½æ„Ÿçš„å…‰æ ‡
    ctx.beginPath();
    ctx.arc(x, y, 6, 0, Math.PI * 2);
    ctx.fillStyle = 'rgba(255, 100, 100, 0.5)'; // çº¢è‰²è¡¨ç¤ºè¿˜æ²¡å‡†å¤‡å¥½
    ctx.fill();
    
    // ç”»ä¸€ä¸ªç®€å•çš„è¿›åº¦åœˆ
    const progress = Math.min(1, (Date.now() - state.handDetectedTime) / CONFIG.wipeActivationDelay);
    ctx.beginPath();
    ctx.arc(x, y, 12, -Math.PI/2, -Math.PI/2 + progress * Math.PI * 2);
    ctx.strokeStyle = 'rgba(255, 100, 100, 0.8)';
    ctx.lineWidth = 2;
    ctx.stroke();
}

// ==========================================
// UI äº‹ä»¶ç»‘å®š
// ==========================================
function setupUI() {
    document.getElementById('cameraBtn').addEventListener('click', toggleCamera);
    
    const snowBtn = document.getElementById('snowBtn');
    snowBtn.addEventListener('click', () => {
        state.isSnowEnabled = !state.isSnowEnabled;
        snowBtn.textContent = state.isSnowEnabled ? "å¼€" : "å…³";
        snowBtn.classList.toggle('active', state.isSnowEnabled);
    });

    const symmetryBtn = document.getElementById('symmetryBtn');
    symmetryBtn.addEventListener('click', () => {
        state.isSymmetryEnabled = !state.isSymmetryEnabled;
        symmetryBtn.textContent = state.isSymmetryEnabled ? "å¼€" : "å…³";
        symmetryBtn.classList.toggle('active', state.isSymmetryEnabled);
    });
    
    document.getElementById('clearFogBtn').addEventListener('click', () => {
         fogCtx.clearRect(0,0,fogCanvas.width, fogCanvas.height);
    });

    // ç©ºæ ¼é”®å“ˆæ°”
    window.addEventListener('keydown', (e) => { if (e.code === 'Space') state.isSpacebarDown = true; });
    window.addEventListener('keyup', (e) => { if (e.code === 'Space') state.isSpacebarDown = false; });

    // UI é¢æ¿è‡ªåŠ¨éšè—äº¤äº’
    const uiPanel = document.getElementById('uiPanel');
    let uiHideTimeout;
    function resetUiTimer() {
        uiPanel.classList.remove('hidden');
        clearTimeout(uiHideTimeout);
        uiHideTimeout = setTimeout(() => { uiPanel.classList.add('hidden'); }, 5000);
    }
    document.addEventListener('mousemove', resetUiTimer);
    resetUiTimer(); // å¯åŠ¨å®šæ—¶å™¨
}

// å¯åŠ¨ç³»ç»Ÿ
window.onload = initSystem;

</script>
</body>
</html>